# Trigger v4 Worker (supervisor + docker-socket-proxy)
# - TRIGGER_WORKER_TOKEN: Set as variable in Coolify (copied from Webapp logs).
# - Does not use shared volumes or public ports.

services:
  supervisor:
    image: ghcr.io/triggerdotdev/supervisor:v4.0.4
    restart: unless-stopped
    depends_on:
      - docker-proxy
    volumes:
      - shared:/home/node/shared
    # Only needed for bootstrap
    user: root
    # Only needed for bootstrap
    command: sh -c "chown -R node:node /home/node/shared && exec /usr/bin/dumb-init -- pnpm run --filter supervisor start"
    environment:
      TRIGGER_API_URL: ${TRIGGER_API_URL}                    # https://trigger.sidicom.es
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}  # https://trigger.sidicom.es/otel
      TRIGGER_WORKER_TOKEN: ${TRIGGER_WORKER_TOKEN}
      MANAGED_WORKER_SECRET: ${MANAGED_WORKER_SECRET}

      TRIGGER_WORKLOAD_API_DOMAIN: supervisor
      TRIGGER_WORKLOAD_API_PORT_EXTERNAL: 8020

      DOCKER_HOST: tcp://docker-proxy:2375
      DOCKER_RUNNER_NETWORKS: supervisor
      DOCKER_AUTOREMOVE_EXITED_CONTAINERS: true

      # Registry (if your runs use private images):
      DOCKER_REGISTRY_URL: ${DOCKER_REGISTRY_URL}
      DOCKER_REGISTRY_USERNAME: ${DOCKER_REGISTRY_USERNAME}
      DOCKER_REGISTRY_PASSWORD: ${DOCKER_REGISTRY_PASSWORD}

      DEBUG: 1
      ENFORCE_MACHINE_PRESETS: 1
      TRIGGER_DEQUEUE_INTERVAL_MS: 1000

    healthcheck:
      test: ["CMD", "node", "-e", "http.get('http://localhost:8020/health', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s
    networks:
      - supervisor
      - docker-proxy

  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LOG_LEVEL: info
      POST: 1
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
    healthcheck:
      test:
        - CMD-SHELL
        - "busybox nc -z 127.0.0.1 2375"
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - docker-proxy

networks:
  supervisor:
    name: supervisor
    external: true
  docker-proxy:
    name: docker-proxy
    external: true